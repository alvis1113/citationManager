<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citation Generator (Video Ad Enabled)</title>
    
    <!-- Google AdSense ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX"
            crossorigin="anonymous"></script>
    
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        textarea, select, input { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; }
        button { padding: 10px 20px; margin-top: 10px; cursor: pointer; }
        .primary { background-color: #007bff; color: white; border: none; border-radius: 4px; }
        .ad-btn { background-color: #d63384; color: white; border: none; border-radius: 4px; font-weight: bold; }
        
        /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .checkbox-container { margin-top: 15px; margin-bottom: 10px; }
        .checkbox-container label { display: flex; align-items: center; cursor: pointer; }
        .checkbox-container input[type="checkbox"] { 
            width: auto; 
            margin-right: 8px; 
            cursor: pointer;
            transform: scale(1.2);
        }
        
        /* å¼•ç”¨ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .citation-item { margin-bottom: 10px; padding: 10px; border-bottom: 1px solid #eee; }
        /* citeprocãŒå‡ºåŠ›ã™ã‚‹æ›¸å¼ã®ãƒªã‚»ãƒƒãƒˆ */
        .csl-entry { margin-bottom: 0.5em; } 
        .csl-left-margin { display: inline-block; min-width: 2em; } /* ç•ªå·ä»˜ãã®å ´åˆ */
        .csl-right-inline { display: inline; }

        /* å‹•ç”»åºƒå‘Šãƒ¢ãƒ¼ãƒ€ãƒ« */
        #adModal {
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            justify-content: center; align-items: center; flex-direction: column;
            color: white;
        }
        #adVideo { max-width: 90%; max-height: 80vh; border: 2px solid white; }
        .ad-message { margin-bottom: 15px; font-size: 1.2em; }
        .skip-counter { font-size: 0.9em; color: #ccc; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>è«–æ–‡å¼•ç”¨ä½œæˆãã‚“ (CSLç‰ˆ + å‹•ç”»åºƒå‘Š)</h2>
    
    <label>è«–æ–‡ID (PubMed, ArXiv, bioRxiv DOI)</label>
    <textarea id="inputIds" rows="5" placeholder="ä¾‹:
34567890
2103.12345"></textarea>
    
    <label>ã‚¹ã‚¿ã‚¤ãƒ«å (CSLã®ãƒ•ã‚¡ã‚¤ãƒ«å)</label>
    <input type="text" id="styleName" value="nature" placeholder="ä¾‹: nature, science, cell, apa, ieee">
    <small>â€» <a href="https://github.com/citation-style-language/styles" target="_blank">CSLãƒªãƒã‚¸ãƒˆãƒª</a>ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆ.cslé™¤ãï¼‰ã‚’å…¥åŠ›</small>
    <br>

    <div class="checkbox-container">
        <label>
            <input type="checkbox" id="sortAlphabetically">
            ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ï¼ˆè‘—è€…åï¼‰ã§ã‚½ãƒ¼ãƒˆã™ã‚‹
        </label>
    </div>

    <button class="primary" onclick="generateCitations()">ãƒªã‚¹ãƒˆã‚’ä½œæˆ</button>

    <div id="resultArea" style="display:none; margin-top:20px;">
        <hr>
        <h3>å‡ºåŠ›çµæœ</h3>
        <div id="citationList" style="background:#fafafa; padding:10px; border:1px solid #ddd;"></div>
        
        <button class="ad-btn" onclick="openAdModal()">
            ğŸ“º å‹•ç”»ã‚’è¦‹ã¦ã‚³ãƒ”ãƒ¼ (CM)
        </button>
    </div>
</div>

<div id="adModal">
    <div class="ad-message">åºƒå‘Šã‚’å†ç”Ÿä¸­... (çµ‚äº†å¾Œã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã™)</div>
    <video id="adVideo" width="600" controls disablePictureInPicture controlsList="nodownload">
        <source src="https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>
    <div class="skip-counter" id="adStatus">æœ€å¾Œã¾ã§è¦–è´ã—ã¦ãã ã•ã„</div>
</div>

<script>
    async function generateCitations() {
        const ids = document.getElementById('inputIds').value;
        const style = document.getElementById('styleName').value;
        const sortAlphabetically = document.getElementById('sortAlphabetically').checked;
        const listDiv = document.getElementById('citationList');
        const resultArea = document.getElementById('resultArea');
        
        // å‡¦ç†ä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆçµæœã‚¨ãƒªã‚¢ã«ï¼‰
        resultArea.style.display = 'block';
        resultArea.querySelector('h3').textContent = 'ç”Ÿæˆä¸­...';
        resultArea.querySelector('p').textContent = 'CSLãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ãƒ»æ•´å½¢ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚';

        try {
            const response = await fetch('/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    ids: ids, 
                    style: style,
                    sortAlphabetically: sortAlphabetically
                })
            });
            const data = await response.json();

            listDiv.innerHTML = '';
            data.citations.forEach(html => {
                const div = document.createElement('div');
                div.className = 'citation-item';
                div.innerHTML = html; 
                listDiv.appendChild(div);
            });

            // ç”Ÿæˆå®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            resultArea.querySelector('h3').textContent = 'ç”Ÿæˆå®Œäº†';
            resultArea.querySelector('p').textContent = 'å¼•ç”¨æ–‡çŒ®ãƒªã‚¹ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚';

            // 0.5ç§’å¾Œã«AdSenseåºƒå‘Šã‚’è¡¨ç¤º
            setTimeout(() => {
                const adsenseContainer = document.getElementById('adsenseContainer');
                adsenseContainer.style.display = 'block';
                
                // AdSenseåºƒå‘Šã‚’èª­ã¿è¾¼ã‚€
                try {
                    (adsbygoogle = window.adsbygoogle || []).push({});
                } catch (e) {
                    console.error('AdSense error:', e);
                }
            }, 500);

        } catch (error) {
            resultArea.querySelector('h3').textContent = 'ã‚¨ãƒ©ãƒ¼';
            resultArea.querySelector('p').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error;
        }
    }

    // --- å‹•ç”»åºƒå‘Šãƒ­ã‚¸ãƒƒã‚¯ ---

    function openAdModal() {
        const modal = document.getElementById('adModal');
        const video = document.getElementById('adVideo');
        const status = document.getElementById('adStatus');
        
        modal.style.display = 'flex';
        video.currentTime = 0;
        
        // å‹•ç”»å†ç”Ÿé–‹å§‹
        video.play().catch(e => {
            console.log("è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ã§ã™ã€‚");
        });

        // å†ç”Ÿçµ‚äº†æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        video.onended = function() {
            modal.style.display = 'none';
            performCopy(); // ã‚³ãƒ”ãƒ¼å®Ÿè¡Œ
        };
        
        // ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰å¼·åˆ¶çš„ã«è¦‹ã›ã‚‹ãŸã‚ã«ã€ã‚·ãƒ¼ã‚¯ç¦æ­¢ãªã©ã‚’JSã§åˆ¶å¾¡ã™ã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™
    }

    async function performCopy() {
        const listDiv = document.getElementById('citationList');
        
        // HTMLå½¢å¼ã§ã‚³ãƒ”ãƒ¼ï¼ˆæ›¸å¼ã‚’ä¿æŒï¼‰
        const htmlContent = listDiv.innerHTML;
        
        // ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç‰ˆã‚‚ç”¨æ„ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
        const textContent = listDiv.innerText;
        
        // åºƒå‘Šãƒªãƒ³ã‚¯ï¼ˆHTMLç‰ˆã¨ãƒ†ã‚­ã‚¹ãƒˆç‰ˆï¼‰
        const adLinkHtml = '<br><br>----------<br>Supported by Citation Maker<br><a href="http://example.com">http://example.com</a>';
        const adLinkText = "\n\n----------\nSupported by Citation Maker\nhttp://example.com";
        
        try {
            // ClipboardItem ã‚’ä½¿ç”¨ã—ã¦HTMLã¨ãƒ†ã‚­ã‚¹ãƒˆã®ä¸¡æ–¹ã‚’ã‚³ãƒ”ãƒ¼
            const htmlBlob = new Blob([htmlContent + adLinkHtml], { type: 'text/html' });
            const textBlob = new Blob([textContent + adLinkText], { type: 'text/plain' });
            
            const clipboardItem = new ClipboardItem({
                'text/html': htmlBlob,
                'text/plain': textBlob
            });
            
            await navigator.clipboard.write([clipboardItem]);
            alert("åºƒå‘Šã®ã”è¦–è´ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\nã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nï¼ˆæ›¸å¼æƒ…å ±ã‚’å«ã‚€ï¼‰");
        } catch (err) {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶å‘ã‘
            try {
                // HTMLè¦ç´ ã‚’ä¸€æ™‚çš„ã«ä½œæˆã—ã¦ã‚³ãƒ”ãƒ¼
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent + adLinkHtml;
                tempDiv.style.position = 'absolute';
                tempDiv.style.left = '-9999px';
                document.body.appendChild(tempDiv);
                
                // é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼
                const range = document.createRange();
                range.selectNodeContents(tempDiv);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                document.execCommand('copy');
                
                // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                selection.removeAllRanges();
                document.body.removeChild(tempDiv);
                
                alert("åºƒå‘Šã®ã”è¦–è´ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\nã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
            } catch (err2) {
                console.error('Copy failed:', err, err2);
                alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
            }
        }
    }
</script>

</body>
</html>